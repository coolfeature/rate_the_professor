{% load static %}
<!DOCTYPE html>
<html>
<head>
	<title>Rate The Professor</title>

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- Bootstrap -->
	<!--link href="{% static 'css/bootstrap-fluid-adj.css' %}" rel="stylesheet"-->
    <link href="{% static 'js/jquery-2.1.0.min.js' %}" type="text/javascript">
	<link href="{% static 'css/bootstrap-responsive.css' %}" rel="stylesheet">
	<link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet" media="screen">

	<link rel="shortcut icon" href="/img/favicon.ico">

	<!-- CSS is written here for convenience; will move to a separate .css file when complete -->
	<style type="text/css">
	.navbardiv {
		background: url({% static 'img/banner.jpg' %});
		margin-bottom: 50px;
	}
	.logo {
		width: 200px;
	}
	.profpic {
		float: left;
	}
	.profpic img {
		border: 3px solid;
	}
	.profinfo {
		margin-left: 120px;
	}
	.errorlist {
		float: right;
	}
	table.formtable th {
		text-align: left;
		width: 150px;
	}
	.login-area {
		padding: 10px;
	}
	footer {
		margin-top: 50px;
	}
	div #login_result {
		color: #FF4040;
	}
	.comment-pic {
		width: 50px;
	}
	.comment-prof {
		font-size: 8pt;
	}
	.rating-block {
		width: 80px;
	}
	.prof-rating-form input {
		display: none;
	}
	.rating-form {
		//margin-left: 20px;
	}
	#id_comment {
		display: block;
	}
	</style>
</head>

<body>
	<div class="container">

		<!-- NAVIGATION BAR -->
		<div class="navbardiv row-fluid">
			<!-- RATE THE PROFESSOR LOGO -->
			<div class="span3">
				<a href="/rate_the_professor/"><img src="{% static 'img/logo.png' %}" class="logo"></a>			
			</div>

			<!-- TOP RIGHT LOGIN/LOGOUT AREA -->
			<div class="login-area">
				{% if user.is_authenticated %}

                <!-- USER THUMBNAIL -->
				<div class="pull-right">
                    <a href="/rate_the_professor/user/"><p>HELLO: {{ user.username }}</p></a>
				</div>

				<!-- LOGOUT BUTTON -->
				<div class="pull-right">
					<form action="/rate_the_professor/logout/">
					    <button type="submit" value="Logout" class="btn btn-primary">Logout</button>
					</form>
				</div>


				{% else %}
				<!-- REGISTER BUTTON -->
				<div class="pull-right">
					<form action="/rate_the_professor/register/">
						<button type="submit" class="btn btn-primary">Register</button>
					</form>
				</div>
				<!-- USERNAME/PASSWORD INPUT FIELDS -->
				<div class="pull-right">
					<form class="form-inline" id="login_form" method="post" action="/rate_the_professor/login/">
						{% csrf_token %}
						<input class="input-small" input size="50" value="" id="id_username" name="username" placeholder="Username" type="text"/>
						<input class="input-small" size="50" value="" id="id_password" name="password" placeholder="Password" type="password" />
						<button type="submit" class="btn btn-primary">Sign in</button>
	                    <div id="login_result"></div>
					</form>
				</div>
				{% endif %}
			</div>
		</div>


		<!-- CONTENT OF PAGE -->
        <div>
            {% block body_block %}{% endblock %}
        </div>

	</div>

	<footer>
		<div class="container">
			<p>&copy; iTech4Leif 2014</p>
		</div>
	</footer>

	<!-- JAVASCRIPT -->
	<script src="{% static 'js/jquery-2.1.0.min.js' %}"></script>
	<script src="{% static 'js/bootstrap.min.js' %}"></script>
	<script type="text/javascript">
		// -------- LOGIN AJAX ---------------//
	    var frm = $('#login_form');
	    frm.submit(function () {
	        $.ajax({
	            type: "POST",
	            url: "/rate_the_professor/login/",
	            data: frm.serialize(),
	            success: function (data) {
	                window.location = data;
	            },
	            error: function(data) {
	                $('#login_result').html("Invalid login details supplied.");
	            }
	        });
	        return false;
	    });

	    // ------------ DYNAMIC PROFESSOR SEARCH FORM -------------------- //
	    $('#query').keyup(function(){
	        var query;
	        query = $('#query').val();
	        if (query !== "") {
	        $.get('/rate_the_professor/suggest_professor/', {suggestion: query, max_results: 4}, function(data){
	            $('#suggested_professors').html(data);
	        });
	        } else {
	            $('#suggested_professors').html("");
	        }
	    });

	    // ---------------- search form stuff -----------------//
	    $("#search_form").submit(function(event) {
			event.preventDefault();
			var $form = $( this ),
			url = $form.attr( 'action' );
			var posting = $.get( url, { suggestion: $('#query').val(), max_results: 0 } );
			posting.done(function( data ) {
				if (data !== "") {
					$('#ratings-main').html(data);
					$('#query').val("");
					$('#suggested_professors').html("");
				}
			});
	    });

	    // -------------- CHANGE RECENT COMMENT RATINGS TO STARS ------------ //
		function ratingToStars() {
			var recentRatings = $('.rating');
			recentRatings.each(function(i){
				var rating = Math.round($(this).html());
				var html = "<div class='rating-block'>";
				
				// var halfStars = rating % 2;
				for (var i = 0; i < 5; i++)
				{
					if (i <= rating)
						html += "<img src='{% static 'img/star_y_small.png' %}'>";
					else
						html += "<img src='{% static 'img/star_g_small.png' %}'>";
				}
				html += "</div>"
				$(this).html(html);
			});
		}

		// ---------- DISPLAY DYNAMIC STARS ON PROFESSOR'S PAGE ----------- //
		var MAX_RATING = 5;
		var ratings;

		function initialiseProfessorRatingsForm() {
			
			var ratingFormElems = $('.prof-rating-form').find("input");
			ratingFormElems.each(function(i){
				if (i < 6)
					$(this).after("<span class='rating-form' id='rating" + i + "'><input id='star1' type='radio' name='rating' value='1.0'><img class='stars' src={% static 'img/star_g.png' %}><input id='star2' type='radio' name='rating' value='2.0'><img class='stars' src={% static 'img/star_g.png' %}><input id='star3' type='radio' name='rating' value='3.0'><img class='stars' src={% static 'img/star_g.png' %}><input id='star4' type='radio' name='rating' value='4.0'><img class='stars' src={% static 'img/star_g.png' %}><input id='star5' type='radio' name='rating' value='5.0'><img class='stars' src={% static 'img/star_g.png' %}>");
			});

			$(".stars").hover(
				function() {
					$(this).prevAll("img").prop("src", "{% static 'img/star_r.png' %}");
					$(this).prop("src", "{% static 'img/star_r.png' %}");
				}, function() {
					var ratingId = $(this).parent().attr("id");
					refreshRating(ratingId);
				}
			);
			
			$(".stars").click(function() {
				var ratingId = $(this).parent().attr("id");
				var ratingValue = $(this).prev().attr("value");
				var ratingIdNumber = ratingId.substr(6, ratingId.length - 6);
				//$(this).parent().prev().prop("value", "1");
				//alert($(this).parent().prev().attr("value"));
				ratings[ratingIdNumber] = ratingValue;
				if (ratingId === "rating0") {
				    $('#id_communication').val(ratingValue);
				}
				if (ratingId === "rating1") {
				    $('#id_knowledge').val(ratingValue);
				}
                if (ratingId === "rating2") {
				    $('#id_approachability').val(ratingValue);
				}
				if (ratingId === "rating3") {
				    $('#id_enthusiasm').val(ratingValue);
				}
				if (ratingId === "rating4") {
				    $('#id_clarity').val(ratingValue);
				}
				if (ratingId === "rating5") {
				    $('#id_awesomeness').val(ratingValue);
				}
				refreshRating(ratingId);
			})

			var ratingExists = true;
			var ratingIds = 0;
			
			while (ratingExists) {
				if ($('#rating' + ratingIds).length > 0)
					ratingIds++;
				else
					ratingExists = false;
			}
			
			ratings = new Array(ratingIds);
			
			for (var i = 0; i < ratings.length; i++)
				ratings[i] = 0;
		}
		
		function getSelectedRating(ratingId) {
			var ratingIdNumber = ratingId.substr(6, ratingId.length - 6);
			return ratings[ratingIdNumber];
		}

		function refreshRating(ratingId) {
			var starRating = getSelectedRating(ratingId);
			for (var i = 1; i <= MAX_RATING; i++) {
				if (i <= starRating)
					$("#" + ratingId).children("#star" + i).next().prop("src", "{% static 'img/star_y.png' %}");
				else
					$("#" + ratingId).children("#star" + i).next().prop("src", "{% static 'img/star_g.png' %}");
			}
		}


		$(document).ready(function() {
			ratingToStars();
			initialiseProfessorRatingsForm();
		});
    </script>
</body>
</html>